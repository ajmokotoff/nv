function sizeBySeverity(){NV.treemap.set("sizeOption","cvss")}function sizeByCriticality(){NV.treemap.set("sizeOption","criticality")}function sizeByCount(){NV.treemap.set("sizeOption","value")}function colorBySeverity(){NV.treemap.set("colorOption","cvss")}function colorByCriticality(){NV.treemap.set("colorOption","criticality")}function colorByCount(){NV.treemap.set("colorOption","count")}function setNBEData(e){NV.nessus.setData(e)}function handleGroupAdd(){var e=$("#ipStart").val(),t=$("#ipEnd").val(),n=$("#groupName").val(),r=$("#defaultWeight").val(),i={start:e,end:t,groupName:n,weight:r};groupList.push(i),NV.nessus.trigger("change:groups"),d3.select("#coloroptions").selectAll("button").attr("disabled",null),d3.select("#sizeoptions").selectAll("button").attr("disabled",null),d3.select("#coloroptions").selectAll("button").attr("title",null),d3.select("#sizeoptions").selectAll("button").attr("title",null),updateCurrentGroupTable()}function clearData(){eventList={},groupList=[],$("#file-list").html(""),$("#file-reset-btn").addClass("disabled"),$("#file-continue-btn").addClass("disabled"),$("#groups-continue-btn").addClass("disabled"),$("#groupsTabNav").addClass("disabled"),$("#visTabNav").addClass("disabled")}function dataTabActive(){$("#file-status-msg").html(""),$("#file-status").alert("close")}function dataLoaded(e){$("#groupsTabNav").removeClass("disabled"),$("#file-status").css("display","block"),$("#file-status").addClass("alert-success"),$("#file-status-msg").html('<i class="icon-file"></i> <strong>'+e+"</strong> loaded in browser."),$("#file-list").append(' <i class="icon-file"></i> '+e),$("#file-reset-btn").removeClass("disabled"),$("#file-continue-btn").removeClass("disabled")}function groupsTabActive(){eventList||updateEventList(),updateCurrentGroupTable(),$("#visTabNav").removeClass("disabled"),$("#groups-continue-btn").removeClass("disabled")}function visTabActive(){eventList||(updateEventList(),updateCurrentGroupTable()),$("#helpIcon").tipsy("show"),setTimeout(function(){$("#helpIcon").tipsy("hide")},2500),NV.treemapView.render()}function updateEventList(){var e="",t="";e=parseNBEFile(nbeText1),eventList=e,nbeText2.trim()!==""&&(NV.nessus.set("isChangeVis",!0),t=parseNBEFile(nbeText2),eventList=mergeNBEs(e,t))}function updateCurrentGroupTable(){eventList||(console.log("updateCurrentGroupTable needed to update eventList: this is unexpected."),updateEventList());var e=findIPsInList(eventList);groups={};for(var t=0;t<e.length;t++){var n=findGroupName(e[t]),r=1;for(var i=0;i<groupList.length;i++)groupList[i].groupName===n&&(r=groupList[i].weight);var s={ip:e[t],weight:r};groups[n]||(groups[n]=[]),groups[n].push(s)}buildTable(groups),eventList=addGroupInfoToData(groups,eventList),setNBEData(eventList)}function mergeNBEs(e,t){function f(e,t){return e.ip===t.ip&&e.vulnid===t.vulnid&&e.vulntype===t.vulntype&&e.cvss===t.cvss&&e.port===t.port?!0:!1}var n=[],r=0,i=0,s,o,u,a;for(o=0;o<e.length;o++){s=!1;for(u=0;u<t.length;u++)if(f(e[o],t[u])){s=!0,a=e[o],a.state="open",n.push(a),t.splice(u,1),r+=1;break}s===!1&&(a=e[o],a.state="fixed",n.push(a),i+=1)}console.log("open items: "+r),console.log("changed items: "+i),console.log("new items: "+t.length);while(t.length>0)a=t.pop(),a.state="new",n.push(a);return n}function findIPsInList(e){var t={};for(var n=0;n<e.length;n++)t[e[n].ip]=!0;return t=Object.keys(t),t}function findGroupName(e){function n(e,t){for(var n=0;n<4;n++)if(parseInt(e[n],10)>parseInt(t[n],10))return!1;return!0}function r(e,t){return n(t,e)}var t=e.split(".");if(t.length!==4)throw"address of "+groupList[i].end+" is invalid";for(var i=0;i<groupList.length;i++){var s=groupList[i].start.split(".");if(s.length!==4)throw"start address of "+groupList[i].start+" is invalid";var o=groupList[i].end.split(".");if(o.length!==4)throw"end address of "+groupList[i].end+" is invalid";if(n(s,t)&&r(o,t))return groupList[i].groupName}return"none"}function addGroupInfoToData(e,t){var n=[],r={},i=Object.keys(e),s,o;for(o=0;o<i.length;o++){var u=e[i[o]];for(s=0;s<u.length;s++)r[u[s].ip]={group:i[o],weight:u[s].weight}}for(s=0;s<t.length;s++)n.push(t[s]),n[s].group=r[t[s].ip].group,n[s].criticality=parseInt(r[t[s].ip].weight,10);return n}function buildTable(e){$("#currentGroupTable").select("tbody").html("");var t,n,r=Object.keys(e);for(var i=0;i<r.length;i++){var s=e[r[i]];for(var o=0;o<s.length;o++)t='<select class="weightSelect" id="weightSelect'+s[o].ip.split(".").join("_")+'"',t+='><option value="1">1 (lowest)</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10 (highest)</option></select>',n="<tr>",n+="<td>"+r[i]+"</td><td>"+s[o].ip+"</td>",n+="<td>"+t+"</td>",n+="</tr>",$("#currentGroupTable").select("tbody").append(n),$("#weightSelect"+s[o].ip.split(".").join("_")).children().eq(s[o].weight-1).attr("selected","selected")}}(function(){"use strict";return $(window).resize(function(){NV.resize()}),$(function(){NV.start({pushState:!0})}),{}})(),d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},d3.stringWidth=function(e,t,n,r){var i=n||"12px arial",s=e.append("text").attr("class",r).style("font",i).style("opacity",0).style("visibility","hidden").style("display","inline").text(t),o=s.node().getComputedTextLength();return d3.select(s).remove(),o};var ColorLegend=Backbone.Model.extend({initialize:function(){this.makeScales(10);var e=["fixed","open","new"],t=["severity"];this.set("activeColors",t),this.get("datasource").on("change:isChangeVis",function(){var n=this.get("datasource").get("isChangeVis");n?this.set("activeColors",e):this.set("activeColors",t)},this)},makeScales:function(e){var t=["#F1EEF6","#E5E7FF","#DFE0F7","#CAD5ED","#A6BDDB","#74A9CF","#3690C0","#0570B0","#045A8D","#3578A0"],n=d3.hsl("#F1EEF6"),r=d3.hsl("#2B8CBE"),i=d3.hsl("#405E50"),s=d3.hsl("#AD009F"),o=d3.hsl("#FFCF40"),u=d3.scale.quantize().domain([0,e]).range(t),a=d3.scale.linear().domain([0,e]).range([n,i]).clamp(!0),f=d3.scale.linear().domain([0,e]).range([n,o]).clamp(!0),l=d3.scale.linear().domain([0,e]).range([n,s]).clamp(!0);this.set("severity",u),this.set("fixed",a),this.set("open",f),this.set("new",l)}}),Hierarchy=Backbone.Model.extend({initialize:function(){var e=[{target:"nv"},{useData:!0,target:"ip"},{prefix:":",useData:!0,target:"port"},{prefix:"id",useData:!0,target:"vulnid"}];this.set({data:e,silent:!0}),this.get("datasource").on("change:isChangeVis",function(){var e=this.get("datasource").get("isChangeVis"),t=this.get("data");e?t.push({useData:!0,target:"state"}):t=_.filter(t,function(e){return e.target!=="state"}),this.set("data",t),this.trigger("change:data")},this),this.get("datasource").on("change:groups",function(){var e=this.get("data"),t=_.find(e,function(e){return e.target==="group"});t||e.splice(1,0,{useData:!0,target:"group"}),this.set("data",e),this.trigger("change:data")},this),this.get("app").on("hierarchyChange",function(e){this.set("data",e)},this)}}),Histogram=Backbone.Model.extend({initialize:function(){this.on("change:limit",this.updateData,this),this.get("datasource").on("dataset updated",this.updateData,this)},updateData:function(){var e=this.get("filterOptions"),t=e.attribute,n=this.get("bins")||"",r=this.get("range")||"",i=this.get("datamap")||"",s=this.get("datasource").getData(e),o=d3.layout.histogram().value(function(e){return i?i(e[t]):e[t]});n&&o.bins(n),r&&o.range(r);var u=o(s);this.get("limit")&&(u=_.sortBy(u,function(e){return e.length}).reverse(),u.length>this.get("limit")&&(u=_.first(u,this.get("limit"))));var a;n?a=u.map(function(e,t){return i?i.domain()[t]:t+1}):a=u.map(function(e){if(e[0])return e[0][t]}),this.set("data",u.map(function(e,t){return{length:e.length,label:a[t]}}))}}),Nessus=Backbone.Model.extend({initialize:function(){this.logs=crossfilter();var e=this;$.each(this.get("dimensions"),function(t,n){e["by"+n]=e.logs.dimension(function(e){return e[n]})}),this.isChangeVis=!1},getData:function(e){var t=e||{},n=t.limit||Infinity;t.useGlobalFilters?this.activateFilters(this.get("filters")):this.clearFilters(),t.filters&&t.filters.length>0&&this.activateFilters(t.filters);var r=this["by"+t.attribute].top(n);return this.clearFilters(),r},setData:function(e){this.logs.size()>1&&(this.logs=crossfilter()),this.logs.add(e),this.trigger("dataset updated")},updateFilter:function(e){var t=e.split(";"),n=t.map(function(e){return e.split(",")}),r=n.map(function(e){return{attribute:e[0],rangeMin:e[1],rangeMax:e[2]}});this.set("filters",r),this.trigger("filterChange",r)},activateFilters:function(e){var t=e||[];if(t.length<1)return;var n=this;$.each(t,function(e,t){t.exact?n["by"+t.attribute].filter(t.exact):n["by"+t.attribute].filter([t.rangeMin,t.rangeMax])})},clearFilters:function(){var e=this;$.each(this.get("dimensions"),function(t,n){e["by"+n].filterAll()})}}),NessusInfo=Backbone.Model.extend({initialize:function(){var e=this;this.get("app").on("treemap_mouseover",function(e){e.indexOf("id")!==-1&&(e=e.replace("id",""),this.updateData(e))},this),this.get("app").on("histogramMouseover",function(e){(e.chart.indexOf("notes")!==-1||e.chart.indexOf("holes")!==-1)&&this.updateData(e.label)},this),$.get("data/vulnIDs.json",function(t){e.set("vulnIdInfo",t)})},updateData:function(e){var t=this.get("vulnIdInfo")[e];t.vulnid=e,this.set("data",t)}}),Treemap=Backbone.Model.extend({initialize:function(){this.set("sizeOption","cvss"),this.set("colorOption","cvss"),this.get("datasource").on("dataset updated",this.updateData,this),this.on("change:sizeOption",this.updateData,this),this.on("change:colorOption",this.updateData,this),this.on("change:filterOptions",this.updateData,this),this.get("hierarchy").on("change",this.updateData,this),this.get("app").on("histogramClick",function(e){e.state==="off"?t("remove"):e.chart==="cvss"?(e.label=e.label-1,t("cvss",e.label+0,e.label+1.01)):e.chart==="vuln type"?t("vulntype",e.label):e.chart==="top holes"?t("vulnid",e.label):e.chart==="top notes"&&t("vulnid",e.label)});var e=this,t=function(n,r,i){var s=e.get("filterOptions");n==="remove"?s.filters=null:i?s.filters=[{attribute:n,rangeMin:r,rangeMax:i}]:s.filters=[{attribute:n,exact:r}],e.set("filterOptions",s),e.updateData()}},updateData:function(){function s(e){var t=d3.nest();return _.each(e,function(e){t.key(function(t){return e.useData?e.prefix?e.prefix+t[e.target]:t[e.target]:e.target})}),t.sortKeys(d3.ascending),t.entries(r)}var e=this.get("filterOptions"),t=e.attribute,n=this.get("hierarchy").get("data"),r=this.get("datasource").getData(e);if(r.length<1){console.log("current filter yields no data, try another");return}var i=s(n);i=i[0],this.accumulate(i),this.set("data",i)},accumulate:function(e){function n(e){return e.values?e.count=e.values.reduce(function(e,t){return e+n(t)},0):e.value}function r(e){return e.values?e.cvss=e.values.reduce(function(e,t){return Math.max(e,r(t))},0):e.cvss}function i(e){return e.values?e.criticality=e.values.reduce(function(e,t){return Math.max(e,i(t))},0):e.criticality}function s(e){return e.values?e.state=e.values.reduce(function(e,t){return s(t)},0):e.state}function o(e){return e.values?e.fixedCount=e.values.reduce(function(e,t){return e+o(t)},0):e.state==="fixed"?1:0}function u(e){return e.values?e.openCount=e.values.reduce(function(e,t){return e+u(t)},0):e.state==="open"?1:0}function a(e){return e.values?e.newCount=e.values.reduce(function(e,t){return e+a(t)},0):e.state==="new"?1:0}var t=this;return e.cvss=r(e),e.count=n(e),e.criticality=i(e),this.get("datasource").get("isChangeVis")&&(e.state=s(e),e.fixedCount=o(e),e.openCount=u(e),e.newCount=a(e)),e.values?e.value=e.values.reduce(function(e,n){return e+t.accumulate(n)},0):e[this.get("sizeOption")]}}),ColorLegendView=Backbone.View.extend({initialize:function(){this.model.on("change",this.render,this),this.render()},render:function(){var e=150,t=30,n=26,r=15,i=this.model.get("activeColors"),s=d3.select(this.options.target),o=this,u=s.selectAll(".legendEntry").data(i,function(e){return e}),a=u.enter().append("div").classed("legendEntry",!0).append("svg").attr("width",e).attr("height",t);a.selectAll("rect").data(d3.range(1,10)).enter().append("rect").attr("width",r).attr("height",r).attr("x",function(e,t){return t*r}).style("fill",function(e,t){var n=d3.select(this.parentNode).datum(),r=o.model.get(n);return r(t)}).style("stroke",function(e,t){var n=d3.select(this.parentNode).datum(),r=o.model.get(n);return r(t)}),a.append("text").attr("x",e/2).attr("y",n).attr("text-anchor","middle").text(function(e){return e}),a.append("text").attr("x",0).attr("y",n).attr("text-anchor","start").classed("legend_min",!0),a.append("text").attr("x",e-r).attr("y",n).attr("text-anchor","end").classed("legend_max",!0),u.select(".legend_min").text(function(e){return o.model.get(e).domain()[0]}),u.select(".legend_max").text(function(e){return o.model.get(e).domain()[1]}),u.exit().remove()}}),HierarchyView=Backbone.View.extend({initialize:function(){var e=d3.select(this.options.target).append("ul");this.model.on("change:data",this.render,this),this.render()},render:function(){var e=d3.select(this.options.target).select("ul"),t=this.model.get("data"),n=this;e.selectAll("li").remove();var r=e.selectAll("li").data(t,function(e){return e.target});r.enter().append("li").attr("class",function(e){return e.target==="nv"?"hierarchyNode ui-state-disabled":"hierarchyNode"}).text(function(e){return e.target}).append("i").attr("class",function(e){if(e.target!=="nv")return"icon-resize-horizontal"}),r.exit().remove(),$("#hierarchy ul").sortable({items:"li:not(.ui-state-disabled)",cursor:"move",stop:function(e,t){var r=[];$("#hierarchy li").each(function(e,t){r.push(d3.select(t).datum())}),n.options.app.trigger("hierarchyChange",r)}})}}),HistogramView=Backbone.View.extend({initialize:function(){this.model.on("change:data",this.render,this),this.options.app.on("resize",this.resize,this),d3.select(this.options.target).attr("class","span3"),d3.select(this.options.target).append("svg").attr("height",this.options.h)},render:function(){var e=d3.select(this.options.target).select("svg"),t=this.model.get("app"),n=this.model.get("data"),r=this.options.range,i=this.model.get("attribute"),s=this,o=this.options.h,u=this.options.barwidth,a=2,f=this.options.title,l=this,c=n.length,h=e.selectAll(".bar"),p=e.selectAll(".histogramLabel"),d=e.selectAll(".histogramtitle"),v=$(document).innerWidth(),m=(u+a)*c;e.attr("width",m);var g=d3.scale.linear().domain([0,d3.max(n,function(e){return e.length})]).range([1,o-40]);h.data(n,function(e){return e.length}).enter().append("rect").classed("bar inactive",!0).on("click",function(){b(this)}).on("mouseover",function(){y(this)}).attr("width",u).attr("height",function(e,t){return g(e.length)}).attr("x",function(e,t){return t*(u+a)}).attr("y",function(e,t){return o-45-g(e.length)}),p.data(n,function(e){return e.label}).enter().append("text").attr("class","histogramlabel").attr("x",function(e,t){return t*(u+a)+u/2}).attr("y",o-35).attr("text-anchor","middle").text(function(e){return e.label}),d.data([f]).enter().append("text").attr("class","histogramtitle").attr("x",m/2).attr("y",o-20).attr("text-anchor","middle").text(f);var y=function(t){var n={chart:f,label:d3.select(t).data()[0].label};l.options.app.trigger("histogramMouseover",n)},b=function(t){var n=d3.select(t),r=n.classed("active"),i=d3.select(t).data()[0],s={label:i.label,length:i.length,chart:l.options.title};d3.selectAll(".bar").classed("active",!1),d3.selectAll(".bar").classed("inactive",!0),r?s.state="off":(n.classed("active",!0),n.classed("inactive",!1),s.state="on"),l.options.app.trigger("histogramClick",s)}},resize:function(){var e=$(this.options.target).width(),t=this.model.get("limit")||"",n=$(this.options.target+" svg").width(),r=this.options.barwidth,i=2;if(t===0)return;e>n+r+i?this.model.set("limit",t+1):e<n&&this.model.set("limit",t-1)}}),NessusInfoView=Backbone.View.extend({initialize:function(){this.model.on("change:data",this.render,this);var e=$(this.options.target);e.html("<hr><p>"),e.append("Nessus Info View<br /><br />"),e.append("ID: <br />"),e.append("Title: <br />"),e.append("Family: <br />"),e.append("Synopsis: <br />"),e.append("Description: <br />"),e.append("UpdateInfo: <br />"),e.append("Solution: <br />"),e.append("</p>")},render:function(){var e=this.model.get("data"),t=$(this.options.target);t.html("<hr><p>"),t.append("ID: "+e.vulnid+"<br />"),t.append("Title: "+e.title+"<br />"),e.family&&e.family!==""&&t.append("Family: "+e.family+"<br />"),e.otherInfoList.length>0&&t.append(e.otherInfoList[0]+"<br />"),t.append("<br />"),e.synopsis&&e.synopsis!==""&&t.append("Synopsis: "+e.synopsis+"<br /><br />"),e.description&&e.description!==""&&t.append("Description: "+e.description+"<br /><br />"),e.updateInfo&&e.updateInfo!==""&&t.append("UpdateInfo: "+e.updateInfo+"<br /><br />"),e.solution&&e.solution!==""&&t.append("Solution: "+e.solution),t.append("</p>")}}),TreemapView=Backbone.View.extend({initialize:function(){this.model.on("change:data",this.render,this),this.options.app.on("hierarchyChange",this.render,this),this.options.app.on("resize",this.resize,this),this.margin={top:20,right:20,bottom:0,left:0},this.width=960,this.height=500-this.margin.top-this.margin.bottom,this.formatNumber=d3.format(",d"),this.transitioning=!1,this.x=d3.scale.linear(),this.y=d3.scale.linear(),this.treemap=d3.layout.treemap(),this.svg=d3.select("#vis").append("svg").append("g"),this.grandparent=this.svg.append("g").attr("class","grandparent"),this.grandparent.append("rect"),this.grandparent.append("text")},render:function(){function n(e){e.x=e.y=0,e.dx=t.width,e.dy=t.height,e.depth=0}function r(e){e.values&&(t.treemap.nodes({values:e.values}),e.values.forEach(function(t){t.x=e.x+t.x*e.dx,t.y=e.y+t.y*e.dy,t.dx*=e.dx,t.dy*=e.dy,t.parent=e,r(t)}))}function i(e){function h(e){if(t.transitioning||!e)return;t.transitioning=!0;var n=i(e),s=r.transition().duration(1250),o=n.transition().duration(1250);t.x.domain([e.x,e.x+e.dx]),t.y.domain([e.y,e.y+e.dy]),t.svg.style("shape-rendering",null),t.svg.selectAll(".depth").sort(function(e,t){return e.depth-t.depth}),n.selectAll("text").style("fill-opacity",0),s.selectAll("text").call(a).style("fill-opacity",0),o.selectAll("text").call(a).style("fill-opacity",1),s.selectAll("rect").call(f),o.selectAll("rect").call(f),s.remove().each("end",function(){t.svg.style("shape-rendering","crispEdges"),t.transitioning=!1,u()})}var n=e;t.grandparent.datum(e.parent).on("click",h).select("text").text(l(e));var r=t.svg.insert("g",".grandparent").datum(e).attr("class","depth"),c=r.selectAll("g").data(e.values).enter().append("g");return c.filter(function(e){return e.values}).classed("children",!0).attr("id",function(e){return"IP"+e.key.replace(/\./g,"")}).on("click",function(e){s(e)||h(e)}).on("mouseover",function(e){t.options.app.trigger("treemap_mouseover",e.key),d3.select(this).moveToFront(),d3.select(this).select(".parent").style("stroke","black").style("stroke-width","2px")}).on("mouseout",function(e){d3.select(this).select(".parent").style("stroke","").style("stroke-width",""),d3.select(this).select("text").style("font-weight","normal")}),c.selectAll(".child").data(function(e){return e.values||[e]}).enter().append("rect").attr("class","child").style("fill",function(e){var r=t.model.get("colorOption"),i="severity",s=t.options.color.get(i);if(e.state){var u=o([e.fixedCount,e.newCount,e.openCount]);e.state=u===0?"fixed":u===1?"new":"open",e.state==="new"&&(s=t.options.color.get("new")),e.state==="open"&&(s=t.options.color.get("open")),e.state==="fixed"&&(s=t.options.color.get("fixed"))}return r==="count"?t.options.color.makeScales(n.values.length):t.options.color.makeScales(10),s(e[r])}).call(f),c.append("rect").attr("class","parent").call(f).text(function(e){return t.formatNumber(e.value)}).append("title").text(function(e){return e.key}),$(".parent").tipsy({fade:!0,delayIn:777,gravity:$.fn.tipsy.autoNS,html:!0,title:function(){var e=this.__data__;return e.key+"<br /> max cvss: "+e.cvss+"<br /> vuln count: "+e.count}}),c.append("text").attr("dy",".75em").attr("text-anchor","left").text(function(e){return e.key}).classed("rectlabel",!0).call(a),u(),c}function s(e){return e.values&&e.values.length===1&&e.values[0].vulnid?!0:!1}function o(e){var t=-1,n=Number.MIN_VALUE;for(var r=0;r<e.length;r++)e[r]>n&&(n=e[r],t=r);return t}function u(){d3.selectAll(".rectlabel").transition().text(function(e){var t=d3.select(this.parentNode).select(".parent").attr("width"),n=d3.stringWidth(d3.select(this.parentNode),e.key,null,"rectlabel");return n<t?e.key:"..."})}function a(e){e.attr("x",function(e){return t.x(e.x)+6}).attr("y",function(e){return t.y(e.y)+6})}function f(e){e.attr("x",function(e){return t.x(e.x)}).attr("y",function(e){return t.y(e.y)}).attr("width",function(e){return t.x(e.x+e.dx)-t.x(e.x)}).attr("height",function(e){return t.y(e.y+e.dy)-t.y(e.y)})}function l(e){return e.parent?l(e.parent)+"_"+e.key:e.key}var e=this.model.get("data"),t=this;d3.selectAll(".depth").remove(),this.width=$("#vis").width(),t.x.domain([0,t.width]).range([0,t.width]),t.y.domain([0,t.height]).range([0,t.height]),t.treemap.children(function(e,t){return t?null:e.values}).sort(function(e,t){return e.value-t.value}).ratio(t.height/t.width*.5*(1+Math.sqrt(5))).round(!1),d3.select("#vis svg").attr("width",t.width+t.margin.left+t.margin.right).attr("height",t.height+t.margin.bottom+t.margin.top).style("margin-left",-t.margin.left+"px").style("margin-right",-t.margin.right+"px"),d3.select("#vis svg g").attr("transform","translate("+t.margin.left+","+t.margin.top+")"),d3.select("#vis svg .grandparent rect").attr("y",-this.margin.top).attr("width",this.width).attr("height",this.margin.top),d3.select("#vis svg .grandparent text").attr("x",6).attr("y",6-this.margin.top).attr("dy",".75em"),n(e),r(e),i(e)},resize:function(){this.width=$("#vis").width(),this.x.domain([0,this.width]).range([0,this.width]),d3.select("#vis > svg").attr("width",this.width+this.margin.left+this.margin.right),d3.selectAll(".grandparent rect").attr("width",this.width),this.treemap.ratio(this.height/this.width*.5*(1+Math.sqrt(5))),this.render()}}),NV=new(Backbone.Router.extend({routes:{"":"index"},initialize:function(){this.nessus=new Nessus({dimensions:["ip","port","cvss","vulnid","vulntype"]}),this.cvssHistogram=new Histogram({app:this,datasource:this.nessus,bins:10,range:[0,10],filterOptions:{attribute:"cvss"}}),this.cvssHistogramView=new HistogramView({app:this,model:this.cvssHistogram,target:"#cvssHistogram",barwidth:20,w:220,h:165,title:"cvss"});var e=d3.scale.ordinal().domain(["hole","port","note"]).range([1,2,3]);this.vulnTypeHistogram=new Histogram({app:this,datasource:this.nessus,bins:3,datamap:e,filterOptions:{attribute:"vulntype"}}),this.vulnTypeHistogramView=new HistogramView({app:this,model:this.vulnTypeHistogram,target:"#vulnTypeHistogram",barwidth:20,w:66,h:165,title:"vuln type"}),this.topNoteHistogram=new Histogram({app:this,datasource:this.nessus,limit:6,filterOptions:{attribute:"vulnid",filters:[{attribute:"vulntype",exact:"note"}]}}),this.topNoteHistogramView=new HistogramView({app:this,model:this.topNoteHistogram,target:"#topNoteHistogram",barwidth:30,w:180,h:165,title:"top notes"}),this.topHoleHistogram=new Histogram({app:this,datasource:this.nessus,limit:6,filterOptions:{attribute:"vulnid",filters:[{attribute:"vulntype",exact:"hole"}]}}),this.topHoleHistogramView=new HistogramView({app:this,barwidth:30,model:this.topHoleHistogram,target:"#topHoleHistogram",w:180,h:165,title:"top holes"}),this.hierarchy=new Hierarchy({app:this,datasource:this.nessus}),this.hierarchyView=new HierarchyView({app:this,model:this.hierarchy,target:"#hierarchy"}),this.colorLegend=new ColorLegend({app:this,datasource:this.nessus}),this.colorLegendView=new ColorLegendView({app:this,model:this.colorLegend,target:"#colorlegend"}),this.treemap=new Treemap({app:this,datasource:this.nessus,hierarchy:this.hierarchy,filterOptions:{attribute:"vulnid"}}),this.treemapView=new TreemapView({app:this,model:this.treemap,color:this.colorLegend,target:"#vis"}),this.nessusInfo=new NessusInfo({app:this,datasource:this.nessus}),this.nessusInfoView=new NessusInfoView({app:this,model:this.nessusInfo,target:"#nessusinfo"})},start:function(){Backbone.history.start()},resize:function(){this.trigger("resize")}})),eventList,nbeText1="",nbeText2="",groupList=[],handleFileSelect=function(e){var t=document.getElementById(e);typeof window.FileReader=="undefined"?($("#file-status").css("display","block"),$("#file-status").addClass("alert-error"),console.log("FileReader not supported")):console.log("FileReader supported"),t.ondragover=function(){return this.className="hover",!1},t.ondragend=function(){return this.className="",!1},t.ondrop=function(e){this.className="",e.preventDefault();var n=e.dataTransfer.files,r=n[0];return t.loadFile(r),!1},t.loadFile=function(e){console.log("called loadFile");var t=new FileReader;return t.readAsText(e),t.onload=function(t){nbeText1.trim()===""?nbeText1=t.target.result:nbeText2=t.target.result,console.log("Loaded file: "+e.name),dataLoaded(e.name)},t.onerror=function(){$("#file-status").css("display","block"),$("#file-status").addClass("alert-error"),$("#file-status-msg").html("could not parse file "+e.name+" as text")},!1}};$("#sampleDataLink").click(function(){var e="data/testNetworkOpen.nbe";$.get(e,function(t){nbeText1=t,dataLoaded("Sample file: "+e)})}),$().ready(function(){$(".hierarchyHelp").tipsy({trigger:"manual",fade:!0,gravity:"w",offset:-60}),$(".treemapHelp").tipsy({trigger:"manual",fade:!0,gravity:"s",offset:-250}),$(".nessusHelp").tipsy({trigger:"manual",fade:!0,gravity:"e"}),$(".filterHelp").tipsy({trigger:"manual",fade:!0,gravity:"s"}),$("#helpIcon").tipsy({trigger:"manual",fade:!0,gravity:"e"}),$("#helpIcon").on("mouseover",function(){$(".help").tipsy("show")}),$("#helpIcon").on("mouseout",function(){$(".help").tipsy("hide")}),handleFileSelect("file-drop"),$("#file-reset-btn").click(function(e){window.location.reload()}),$("#dataTab1Link").click(function(e){e.preventDefault(),dataTabActive()}),$("#file-continue-btn").click(function(e){$("#groupsTabLink").tab("show"),groupsTabActive()}),$("#groupsTabLink").click(function(e){e.preventDefault(),groupsTabActive()}),$("#addGroupBtn").click(function(e){handleGroupAdd()}),$("#visTabLink").on("show",function(){setTimeout(function(){visTabActive()},100)}),$("#groups-continue-btn").click(function(e){$("#visTabLink").tab("show")}),$("#visTabLink").click(function(e){e.preventDefault()})});var parseNessusResult=function(e){var t=/CVSS Base Score : (\d+\.\d+)/,n=/\D+ \((\d{1,7})\D+\)/,r=e.split("|"),i=r[2],s=parseFloat(r[4]),o=r[5];if(t.test(e))var u=parseFloat(t.exec(e)[1]);else var u=1;if(n.test(e))var a=parseFloat(n.exec(e)[1]);else var a="notes";return{ip:i===undefined?"":i,vulnid:isNaN(s)?0:s,vulntype:o===undefined?"":o.indexOf("Note")!==-1?"note":"hole",cvss:u,value:1,port:a}},parseNessusTimeStamp=function(e){var t=require("moment"),n="ddd MMM DD HH:mm:ss YYYY",r=e.split("|"),i=t(r[r.length-2],n);return i.valueOf()},hasTime=function(e){var t=e.split("|");return t[t.length-2].length>0&&t[0]=="timestamps"},isResult=function(e){return e.split("|")[0]==="results"},parseNBEFile=function(e){var t=e.split("\n"),n=0,r=new Array(2);for(var i=0;i<t.length;i++)isResult(t[i])&&r.push(parseNessusResult(t[i]));return r.filter(function(){return!0})};
